<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
    <head>
    
    	<!-- DevExtreme dependencies -->
		<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-2.2.3.min.js"></script>
		<!-- A DevExtreme library -->
		<script type="text/javascript" src="https://cdn3.devexpress.com/jslib/16.1.14/js/dx.all.js"></script>
		<!--<script type="text/javascript" src="https://cdn3.devexpress.com/jslib/16.1.14/js/dx.web.js"></script>-->
		<!--<script type="text/javascript" src="https://cdn3.devexpress.com/jslib/16.1.14/js/dx.viz.js"></script>-->
		<!--<script type="text/javascript" src="https://cdn3.devexpress.com/jslib/16.1.14/js/dx.viz-web.js"></script>-->
		<!--<script type="text/javascript" src="https://cdn3.devexpress.com/jslib/16.1.14/js/dx.mobile.js"></script>-->
		<!-- Styles -->
		<link rel="stylesheet" type="text/css" href="https://cdn3.devexpress.com/jslib/16.1.14/css/dx.common.css" />
		<link rel="stylesheet" type="text/css" href="https://cdn3.devexpress.com/jslib/16.1.14/css/dx.light.css" />
		
    	<style type="text/css">
			.dx-scheduler-date-table-cell, .dx-scheduler-timeline {
				height: 20px !important;
			}
			.dx-scheduler-time-panel-cell {
				height: 40px !important;
			}
			.dx-scheduler-time-panel-row:first-child .dx-scheduler-time-panel-cell {
			    padding-top: 66px !important;
			}
			.wordwrap { 
			   white-space: pre-wrap;        
			   white-space: -moz-pre-wrap; 
			   white-space: -pre-wrap;     
			   white-space: -o-pre-wrap;   
			   word-wrap: break-word;      
			}
    	</style>
    	
		<script type="text/javascript">
		
			function getTimeString(d) {
				var time = "";
				if (typeof(d) === "string") {
					time = d.substring(11, 16)
				}
				return time;
			};
		    
			function showToast(event, value, type) {
		        DevExpress.ui.notify(event + " \"" + value + "\"", type, 1400);
	   		};
		    
			var projectList;
			$.ajax({
			    async: false,
			    url: 'data/projects',
			    success: function(data) {
			        projectList = data;
			    }
			});
			
			var activityTypeList;
			$.ajax({
			    async: false,
			    url: 'data/activityTypes',
			    success: function(data) {
			        activityTypeList = data;
			    }
			});
						
			function loadAppointmentsForWeek(week) {
				var appointments;
				$.ajax({
			    	async: false,
			   		url: 'calendar/loadAppointmentsForWeek/' + week.toISOString(),
			    	success: function(data) {
			        	appointments = data;
			    	}
				});
		        return appointments;
		    };
		    
		    function insertAppointment(appointmentData) {
		    	$.ajax({
					async: false,
					type: 'POST',
			   		url: 'calendar/appointment/insert',
			   		data: JSON.stringify(appointmentData),
			    	success: function(data) {
			    	},
					contentType:"application/json; charset=utf-8",
					dataType:"json"
				});
		    };
		    
		    function updateAppointment(key, appointmentData) {
				$.ajax({
				    async: false,
					type: 'POST',
			   		url: 'calendar/appointment/update/' + key,
			   		data: JSON.stringify(appointmentData),
			    	success: function(data) {
			    	},
					contentType:"application/json; charset=utf-8",
					dataType:"json"
				});
		    };
		    
		    function deleteAppointment(key) {
				$.ajax({
			    	async: false,
			   		url: 'calendar/appointment/delete/' + key,
			    	success: function(data) {
			    	}
				});
		    };
		    
		    function getProjectById(id) {
				var project;
				$.ajax({
				    async: false,
				    url: 'data/project/' + id,
				    success: function(data) {
				        project = data;
				    }
				});
		        return project;
		    };
		    
		    function getActivityTypeById(id) {
				var activityType;
				$.ajax({
				    async: false,
				    url: 'data/activityType/' + id,
				    success: function(data) {
				        activityType = data;
				    }
				});
		        return activityType;
		    };
		    
		    function getAppointmentById(id) {
				var appointment;
				$.ajax({
				    async: false,
				    url: 'data/appointment/' + id,
				    success: function(data) {
				    	appointment = data;
				    }
				});
		        return appointment;
		    };
		    
			var ds = new DevExpress.data.DataSource({			        	 
	            load: function(loadOptions) {
	            	var d;
	            	if (loadOptions !== undefined && loadOptions.dxScheduler !== undefined && loadOptions.dxScheduler.startDate !== undefined)
            		{
		                return loadAppointmentsForWeek(loadOptions.dxScheduler.startDate);
            		}
	            	else if (loadOptions)
            		{
		                return loadAppointmentsForWeek(loadOptions);
            		}
	            	else {
	            		return null;
	            	}
	            },			         
	            byKey: function(key) {
	                return getAppointmentById(key);
	            },			         
	            insert: function(values) {
	            	insertAppointment(values);
	                ds.reload();
	            },			         
	            update: function(key, values) {
	            	updateAppointment(key.id, values);
	                ds.reload();
	            },			         
	            remove: function(key) {
	            	deleteAppointment(key.id);
	                ds.reload();
	            }			         
	        });
			
			var scheduler;		
			$(function() {
				var isDouble = 0, prevCellData = null;
				
			    scheduler = $("#schCalendar").dxScheduler({
			        dataSource: ds,
			        currentDate: new Date(),
			        startDayHour: 8,
			        endDayHour: 20,
			        cellDuration: 15,
			        firstDayOfWeek: 1,
			        views: ['day', 'week', 'workWeek'],
        			currentView: 'week',
        	        showCurrentTimeIndicator: true,
        			timeZone: 'Europe/Vienna',
        			appointmentTemplate: function(data) {
			            var projectInfo = $.grep(projectList, function(e){ return e.id === data.projectId; })[0];
			            var activityTypeInfo = $.grep(activityTypeList, function(e){ return e.id === data.activityTypeId; })[0];
			     
			            return $('<div>' + 
			                        '<div class="wordwrap">' + projectInfo.name + ' - ' + activityTypeInfo.name + '</div>' +
			                        '<div class="wordwrap">' + getTimeString(data.startDate) + ' - ' + getTimeString(data.endDate) + '</div>' + 
			                        '<div class="wordwrap" style="margin-top: 10px">' + data.subject + '</div>' +
			                        '<div class="wordwrap" style="margin-top: 10px; font-size: 11px">' + (data.body !== null ? data.body : '') + '</div>' +
			                     '</div>'); 
			     
			        },
					onCellClick: function(e){
						e.cancel = true; // cancel all default logic
						if (isDouble == 1) {
							prevCellData = e.cellData;
						}
						isDouble++;
						setTimeout(function () {
							if (isDouble == 2) {
								var focusedCells = e.element.find("td.dx-state-focused");
								if(focusedCells.length > 0){
									var cell = focusedCells[0]; // get the first cell;			                         
									var cdata = $(cell).data("dxCellData") || $($(cell).parents(".dx-item")).data("dxItemData");                     
									e.component.showAppointmentPopup({ startDate: cdata.startDate, endDate: e.cellData.endDate }, true);
								}
							}
							else if (isDouble == 1)
								console.log('Click');
							isDouble = 0;
							prevCellData = null;
						}, 300);
			        },
			        onAppointmentAdded: function(e) {
			            showToast("Added",e.appointmentData.subject, "success");
			        },
			        onAppointmentUpdated: function(e) {
			            showToast("Updated",e.appointmentData.subject, "info");
			        },
			        onAppointmentDeleted: function(e) {
			            showToast("Deleted",e.appointmentData.subject, "warning");
			        },
	                onAppointmentRendered: function (e) {
	                	if (e !== undefined && e.appointmentData !== undefined)
	                	{
				            var activityTypeInfo = $.grep(activityTypeList, function(a){ return a.id === e.appointmentData.activityTypeId; })[0];
		                    e.appointmentElement[0].style.backgroundColor = activityTypeInfo.color;
		                }
	                },
        			onAppointmentFormCreated: function(data) {
			            var form = data.form,
			                startDate = data.appointmentData.startDate;
			    
			                form.option("items", [{
			                    label: {
			                        text: "Project"
			                    },
			                    editorType: "dxSelectBox",
			                    dataField: "projectId",
			                    editorOptions: {
			                        items: projectList,
			                        displayExpr: "name",
			                        valueExpr: "id"
			                    },
			                }, {
			                    label: {
			                        text: "Activity"
			                    },
			                    editorType: "dxSelectBox",
			                    dataField: "activityTypeId",
			                    editorOptions: {
			                        items: activityTypeList,
			                        displayExpr: "name",
			                        valueExpr: "id"
			                    },
			                }, {
			                    dataField: "startDate",
			                    editorType: "dxDateBox",
			                    editorOptions: {
			                        type: "datetime",
			                    }
			                }, {
			                    name: "endDate",
			                    dataField: "endDate",
			                    editorType: "dxDateBox",
			                    editorOptions: {
			                        type: "datetime",
			                    }
			                }, {
			                    label: {
			                        text: "Subject"
			                    },
			                    name: "subject",
			                    dataField: "subject",
			                    editorType: "dxTextBox"
			                }, {
			                    label: {
			                        text: "Description"
			                    },
			                    name: "body",
			                    dataField: "body",
			                    editorType: "dxTextArea",
			                    editorOptions: {
			                    	height: 120
			                    }
			                }]
			            );
			        }
			    }).dxScheduler('instance');
			});
		</script>
		
        <title>calendar</title>
    </head>
    <body>
    	<form th:action="@{/logout}" method="post">
            <input type="submit" value="Sign Out"/>
        </form>
        <div id="schCalendar"></div>
    </body>
</html>